<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë©”ë‰´ ê´€ë¦¬ì</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-4xl mx-auto mt-10 bg-white shadow-md rounded-xl p-6 space-y-8">
    
    <!-- ë©”ë‰´ ê´€ë¦¬ -->
    <section>
      <h2 class="text-xl font-semibold mb-4">ğŸ“‹ ë©”ë‰´ ê´€ë¦¬ì</h2>
      <table class="w-full border text-sm" id="menuTable">
        <thead>
          <tr class="bg-gray-100">
            <th class="border px-2 py-1">ID</th>
            <th class="border px-2 py-1">ì´ë¦„</th>
            <th class="border px-2 py-1">ê°€ê²©</th>
            <th class="border px-2 py-1">í™œì„±</th>
            <th class="border px-2 py-1">ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody id="menuBody"></tbody>
      </table>
      <div class="mt-4 flex gap-2 flex-wrap">
        <button onclick="addMenu()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">â• ë©”ë‰´ ì¶”ê°€</button>
        <button onclick="saveMenus()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">ğŸ’¾ ì €ì¥</button>
        <button onclick="resetMenus()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">ğŸ—‘ï¸ ë©”ë‰´ ì´ˆê¸°í™”</button>
        <button onclick="resetOrders()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">ğŸ§¹ ì£¼ë¬¸ ì´ˆê¸°í™”</button>
        <button onclick="loadChart()" class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800">ğŸ“Š ì£¼ë¬¸í˜„í™© ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <p id="result" class="mt-2 text-sm text-green-600"></p>
    </section>

    <!-- ì£¼ë¬¸ í˜„í™© -->
    <section>
      <h2 class="text-xl font-semibold mb-2">ğŸ“ˆ ì£¼ë¬¸ í˜„í™©</h2>
      <canvas id="orderChart" height="200"></canvas>
    </section>

  </div>

<script>
  const apiBase = "https://gas-proxy.letthelightsurroundyou.workers.dev";
  let chartInstance = null;

  function generateMenuId() {
    return "menu-" + Math.random().toString(36).substring(2, 7);
  }

  function addMenu(menu = { id: generateMenuId(), name: "", price: "", active: true }) {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="border px-2 py-1">${menu.id}</td>
      <td class="border px-2 py-1"><input type="text" value="${menu.name}" class="w-full border rounded px-1 py-0.5" /></td>
      <td class="border px-2 py-1"><input type="number" value="${menu.price}" class="w-full border rounded px-1 py-0.5" /></td>
      <td class="border px-2 py-1 text-center"><input type="checkbox" ${menu.active ? "checked" : ""} /></td>
      <td class="border px-2 py-1 text-center"><button onclick="this.closest('tr').remove()" class="text-red-500">ì‚­ì œ</button></td>
    `;
    row.dataset.id = menu.id;
    document.getElementById("menuBody").appendChild(row);
  }

  async function loadMenus() {
    const res = await fetch(`${apiBase}/?action=getMenus`);
    const data = await res.json();
    document.getElementById("menuBody").innerHTML = "";
    data.forEach(menu => addMenu(menu));
  }

  async function saveMenus() {
    const rows = document.querySelectorAll("#menuBody tr");
    const menus = Array.from(rows).map(row => {
      const cells = row.querySelectorAll("td");
      return {
        id: row.dataset.id || generateMenuId(),
        name: cells[1].querySelector("input").value,
        price: cells[2].querySelector("input").value,
        active: cells[3].querySelector("input").checked
      };
    });

    const res = await fetch(`${apiBase}/?action=saveMenus`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ menus })
    });

    document.getElementById("result").innerText = res.ok ? "âœ… ì €ì¥ ì™„ë£Œ!" : "âš ï¸ ì €ì¥ ì‹¤íŒ¨!";
  }

  async function resetMenus() {
    if (confirm("ì •ë§ë¡œ ë©”ë‰´ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      await fetch(`${apiBase}/?action=resetMenus`, { method: "POST" });
      loadMenus();
    }
  }

  async function resetOrders() {
    if (confirm("ì •ë§ë¡œ ì£¼ë¬¸ì •ë³´ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      await fetch(`${apiBase}/?action=resetOrders`, { method: "POST" });
      loadChart();
    }
  }

  async function loadChart() {
    const res = await fetch(`${apiBase}/?action=getOrders`);
    const orders = await res.json();

    // ë©”ë‰´ëª…ë³„ ì£¼ë¬¸ ìˆ˜ ê³„ì‚°
    const counts = {};
    orders.forEach(o => {
      counts[o.menu] = (counts[o.menu] || 0) + 1;
    });

    const labels = Object.keys(counts);
    const values = Object.values(counts);

    const ctx = document.getElementById('orderChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'ì£¼ë¬¸ ìˆ˜',
          data: values,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => ` ${ctx.raw}ê±´` } }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // ì´ˆê¸° ë¡œë”©
  loadMenus();
  loadChart();
</script>
</body>
</html>
