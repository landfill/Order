<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>메뉴 주문</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-md mx-auto mt-10 bg-white shadow-lg rounded-xl p-6">
    <h2 class="text-xl font-semibold mb-4">☕ 메뉴 선택</h2>

    <div id="menuList" class="space-y-2"></div>

    <div class="mt-4">
      <label class="block text-sm text-gray-600 mb-1">이름 (선택)</label>
      <input type="text" id="userName" class="w-full border px-3 py-2 rounded-md" placeholder="이름을 입력하세요" />
    </div>

    <button id="submitBtn" class="mt-4 w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600">
      주문하기
    </button>

    <p id="result" class="mt-4 text-sm text-center text-green-600"></p>
  </div>

  <script>
    const apiBase = "https://gas-proxy.letthelightsurroundyou.workers.dev";
    const tokenKey = "menu_order_token";
    const submittedKey = "order_submitted";

    function getToken() {
      let token = localStorage.getItem(tokenKey);
      if (!token) {
        token = "anon_" + Math.random().toString(36).substring(2);
        localStorage.setItem(tokenKey, token);
      }
      return token;
    }

async function loadMenus() {
  const list = document.getElementById("menuList");
  list.innerHTML = `<p class="text-gray-500 text-sm">☕ 메뉴를 불러오는 중입니다...</p>`;

  try {
    const res = await fetch(`${apiBase}?action=getMenus`);
    const menus = await res.json();

    if (!menus.length) {
      list.innerHTML = `<p class="text-red-500 text-sm">표시할 수 있는 메뉴가 없습니다.</p>`;
      return;
    }

    list.innerHTML = menus.map(menu => `
      <label class="flex items-center">
        <input type="radio" name="menu" value="${menu.id}" data-name="${menu.name}" class="mr-2" />
        ${menu.name} (${menu.price}원)
      </label>
    `).join("");
  } catch (e) {
    list.innerHTML = `<p class="text-red-500 text-sm">❌ 메뉴 로딩에 실패했습니다.</p>`;
  }
}


    async function submitOrder() {
      if (localStorage.getItem(submittedKey)) {
        alert("이미 주문하셨습니다.");
        return;
      }

      const selected = document.querySelector("input[name=menu]:checked");
      if (!selected) {
        alert("메뉴를 선택하세요.");
        return;
      }

      const payload = {
        action: "submitOrder",
        menu_id: selected.value,
        menu_name: selected.dataset.name,
        user_token: getToken(),
        user_name: document.getElementById("userName").value.trim()
      };

      const res = await fetch(`${apiBase}?action=submitOrder`, {
        method: "POST",
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      const result = document.getElementById("result");

      if (text === "SUCCESS") {
        localStorage.setItem(submittedKey, "1");
        result.innerText = "✅ 주문이 완료되었습니다.";
        document.getElementById("submitBtn").disabled = true;
        document.getElementById("submitBtn").classList.add("opacity-50", "cursor-not-allowed");
      } else {
        result.innerText = "⚠️ 오류: " + text;
      }
    }

    document.getElementById("submitBtn").addEventListener("click", submitOrder);
    loadMenus();
  </script>
</body>
</html>
